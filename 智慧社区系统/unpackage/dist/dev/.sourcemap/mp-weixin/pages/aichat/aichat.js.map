{"version":3,"sources":["uni-app:///main.js","webpack:///E:/project/智慧社区系统/pages/aichat/aichat.vue?e674","webpack:///E:/project/智慧社区系统/pages/aichat/aichat.vue?08ce","webpack:///E:/project/智慧社区系统/pages/aichat/aichat.vue?4007","webpack:///E:/project/智慧社区系统/pages/aichat/aichat.vue?4d51","uni-app:///pages/aichat/aichat.vue","webpack:///E:/project/智慧社区系统/pages/aichat/aichat.vue?7346","webpack:///E:/project/智慧社区系统/pages/aichat/aichat.vue?3847"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","uniCoTaskList","adpid","config","onLoad","console","key","setTimeout","onShow","data","tiwen","scrollTop","userinfoObj","storagedata","typeid","titleext","headimg","keywordstr","scrollIntoView","msgList","requestState","insufficientScore","content","sseIndex","enableStream","isWidescreen","llmModel","keyboardHeight","computed","inputBoxDisabled","NODE_ENV","footBoxPaddingBottom","watch","handler","uni","deep","title","beforeMount","mounted","db","where","field","get","res","length","lastMsg","methods","setLLMmodel","checkIsOpenPush","updateLastMsg","callback","cover","onAdClose","mask","i","score","clearInterval","icon","changeAnswer","illegal","removeMsg","index","matchKeywords","beforeSend","token","showCancel","confirmText","complete","showToast","success","duration","isAi","create_time","msgobj","username","userid","aiid","ainame","isai","send","messages","msgs","findIndex","aiSummaryIndex","role","sseChannel","setLastAiMsgContent","sseEnd","fnSelf","Promise","requestEnd","that","task","coName","funName","param","customUI","reply","summarize","msg","fail","closeSseChannel","showLastMsg","clearAllMsg"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,eAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAmH;AACnH;AAC0D;AACL;AACc;;;AAGnE;AACsM;AACtM,gBAAgB,gNAAU;AAC1B,EAAE,4EAAM;AACR,EAAE,iFAAM;AACR,EAAE,0FAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,qFAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA,aAAa,0PAEN;AACP,KAAK;AACL;AACA,aAAa,sTAEN;AACP,KAAK;AACL;AACA,CAAC;AACD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACpEA;AAAA;AAAA;AAAA;AAAkxB,CAAgB,+xBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;AC2EtyB;AAGA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AANA;;AAGA;;AAEA;;AAEA;AACA;AACA;AACAC;EACA;EACAA;IAAA;EAAA;EACA;EACAA;AACA;;AAEA;AACA,IACAC,QACAC,gBADAD;AAEA;AACA;;AAEA;AACA;AAAA,eAEA;EACAE;IAAA;IAEA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA;IACAC;IACA;IACA;MAAAC;IAAA;IACAD;IACAE;MACA;IACA;EACA;EACAC,2BAEA;EACAC;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACA;MACAC;MACA;MACAC;MACA;MACAC;MAAA;MACA;MACAC;MACA;MACAC;MACA;MACAC;MACA;MACAC;MACA;MACAC;MACA;MACAvB;MACAwB;MACAC;IACA;EACA;EACAC;IACA;IACAC;MACA;MACA;QACA;MACA;MACA;MACA;IACA;IACA;IACAC;MACA;IACA;IACAC;MACA;IACA;EACA;EACA;EACAC;IACAb;MACAc;QAAA;QACA;QACA;QACAC;UACA;UACA;QACA;QACA3B;UACA;QACA;MACA;MACA;MACA4B;IACA;IACAd;MACAa;QACA;QACA;MACA;IACA;IACAR;MACA;MACA;QACAU;MACA;MACA;;MAMAF;QACA5B;QACAG;MACA;IACA;EACA;EACA4B,qCASA;EACAC;IAAA;IAAA;MAAA;MAAA;QAAA;UAAA;YAAA;cAAA,MAEA;gBAAA;gBAAA;cAAA;cACA;cACA;cACAC,gCACA;cAAA;cAAA,OACAA;cACA;cAAA,CACAC;gBACA;gBACA;cACA;cACA;cAAA,CACAC;cACA;cAAA,CACAC;YAAA;cATAC;cAUA;cACAtC;YAAA;cAGA;cACA;cACA;cACA;cACA;cACA;cAEA;cACAQ;cACA;;cAEA;cACA;;cAEA;cACA;;cAEA;cACA+B;cACA;gBACAC;gBACA;kBACA;gBACA;cACA;;cAEA;cACA;;cAEA;cACA;gBACA;cACA;cAwDAX;gBACA;gBACA;gBACA;kBACA;gBACA;cACA;YAAA;YAAA;cAAA;UAAA;QAAA;MAAA;IAAA;EAEA;EACAY;IACAC;MAAA;MACA;QACA1C;QACA;MACA;IACA;IACA;IACA2C;MAAA;MAAA;QAAA;UAAA;YAAA;cAAA;gBAAA;gBAAA;gBAAA,OAGAd;cAAA;gBACA;gBACA;gBAAA;gBAAA;cAAA;gBAAA;gBAAA;gBAEA;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IAEA;IACA;IACAe;MACA;MACA;QACA;MACA;MACA;;MAEA;MACA;QACA;QACAC;MACA;QACA;QACA;UAAAzC;UAAA;UAAA0C;QACA;UACAN;QACA;UACAA;QACA;MACA;MACA;IACA;IACA;IACAO;MAAA;MACA/C;MACA;QACA;QACA;QACA6B;UACAmB;QACA;QACA;UAAA;YAAA;YAAA;cAAA;gBAAA;kBAAA;oBACAC;oBACA;oBACAf,0BACA;oBAAA;oBAAA,OACAA;oBACA;oBAAA,CACAC;oBACA;oBAAA,CACAC;oBACA;oBAAA,CACAC;kBAAA;oBANAC;oBAOA;oBAAA,QAGAA,0BADAY;oBAEAlD;oBACA;sBACA;sBACAmD;sBACA;sBACAtB;sBACA;wBACA;wBACA;wBACA;wBACA;0BACA;0BACA;0BACAA;4BACAE;4BACAqB;0BACA;wBACA;sBACA;oBACA;kBAAA;kBAAA;oBAAA;gBAAA;cAAA;YAAA;UAAA,CACA;UAAA;YAAA;UAAA;QAAA;MACA;IACA;IACA;IACAC;MAAA;MAAA;QAAA;UAAA;YAAA;cAAA;gBACA;gBACA;kBACA;gBACA;gBACA;gBACA;gBACA;kBACA;kBACAC;gBACA;gBACA;gBACA;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IACAC;MACA;MACA;QACAC;MACA;;MAEA;MACA;QACA;MACA;MAEA;IACA;IACAC;MACA;QACA;MACA;;MAEA;MACA;QACA;QACA;UACA;QACA;MACA;;MAEA;IACA;IACAC;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBAAA,KAYA;kBAAA;kBAAA;gBAAA;gBAAA,kCACA7B;kBACAE;kBACAqB;gBACA;cAAA;gBAAA,KAGA;kBAAA;kBAAA;gBAAA;gBACA;gBACAO,4CACA;gBAAA,IACAA;kBAAA;kBAAA;gBAAA;gBAAA,kCAEA9B;kBACA;kBACAZ;kBACA;kBACA2C;kBACA;kBACAC;kBACA;kBACAC;oBACA;oBACA;;oBAEA;oBACAjC;sBACA;sBACAzB;sBACA;sBACA2D;sBACA;sBACAC;wBACA;wBACAnC;0BACA;0BACAE;0BACA;0BACAqB;0BACA;0BACAa;wBACA;sBACA;oBACA;kBAOA;gBACA;cAAA;gBAAA,IAKA;kBAAA;kBAAA;gBAAA;gBAAA,kCAEApC;kBACA;kBACAE;kBACA;kBACAqB;gBACA;cAAA;gBAGA;gBACA;kBACA;kBACAc;kBACA;kBACAjD;kBACA;kBACAkD;gBACA;gBACA;gBACAC;kBACAC;kBACAC;kBACAC;kBACAC;kBACAvD;kBACAwD;gBACA,GACA;gBACAvE;kBACA;gBACA;gBACA;gBACA;gBACA;gBACA;kBACA;gBACA;gBACAF;gBACA;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IACA0E;MAAA;MAAA;QAAA;QAAA;UAAA;YAAA;cAAA;gBACA;gBACA;gBACA;gBACA9E;gBACA;gBACA;gBAEA+E,eACA;gBACAC,mDAEA;gBACA;gBACAC;kBAAA;gBAAA,IACA;gBACA;kBACAC,8CACA;kBACA;kBACAF;kBACA;kBACAA;gBACA;kBACA;kBACAA;gBACA;gBACA;gBACAA;kBAAA;gBAAA;gBACA;;gBAEA;gBACA;gBACAD;kBACA;kBACA;kBACA;kBACA;oBACAI;kBACA;kBACA;oBACA9D;oBACA8D;kBACA;gBACA;;gBAEA;gBACA/E;gBACA;gBAAA;gBAAA,OACA;cAAA;gBAAA,KAMA;kBAAA;kBAAA;gBAAA;gBACA;gBACAgF;gBACA;;gBAEA;gBACA;gBACA;gBACAA;kBACA;kBACA;;kBAEA;kBACA;oBACA;sBACAd;sBACAjD;sBACAkD;oBACA;kBACA;oBACA;oBACA;oBACA;oBACA;kBACA;;kBACA;kBACA;kBACA;gBACA;;gBAEA;gBACAa;kBACAhF;kBACA;kBACA;kBACA;oBACA;sBACA;sBACA;sBACA;wBACA;0BACAkE;0BACAjD;0BACAkD;wBACA;sBACA;wBACA;0BACA3B;wBACA;sBACA;sBACA;oBACA;oBACA;sBACA;sBACA;sBACA;sBACA;wBACA;0BACA0B;0BACAjD;0BACAqC;0BACAa;wBACA;wBACA5B;sBACA;sBACA;sBACA;sBACA;sBACA;sBACA;oBAEA;sBACA0C;oBACA;kBACA;kBACAC;gBACA;gBAAA;gBAAA,OACAF;cAAA;gBAAA;;gBAEA;gBACA;kBACAG;oBACA;oBACA;sBACA;sBACAA;oBACA;oBACA;sBACA;sBACAA;oBACA;kBACA;kBACAC,aACA;oBACAF;oBACAC;kBACA,IACA;oBACAE;oBACAF;kBACA,GACA;oBACA;oBACA;oBACAH;oBACA;oBACAM;kBACA;oBACA;kBAAA,CACA;kBACAA;gBACA;cAAA;gBAGA;gBACAC;kBACAC;kBACAC;kBACAC;oBACAf;oBAAA;oBACAK;oBAAA;oBACA3D;kBACA;kBACAvB;oBACA6F;kBACA;kBACA3B;oBAAA;sBAAA;sBAAA;wBAAA;0BAAA;4BAAA;8BACA;8BACA;8BACA;8BAAA,IACA1B;gCAAA;gCAAA;8BAAA;8BAAA;4BAAA;8BAAA,YAOAA,UAJAsD,yBACAC,iCACA7E,iDACAsC,6BAGA;8BACA;gCACA;gCACAA;gCACAsC;8BACA;8BACA;;8BAEA;8BACA,wEACA5E;gCACA;gCACA;kCACA;kCACAmD;kCACA;kCACAD;kCACA;kCACAjD;kCACA;kCACAqC;gCACA;;gCAEA;gCACAc;kCACAC;kCACAC;kCACAC;kCACAC;kCACAvD;kCACAwD;gCACA,GACA;8BACA;8BAEA;gCACA;gCACA;8BACA;8BACA;8BACA;gCACAzE;gCACA;gCACA;gCACAwD,mCACA;gCACA;kCACAA;gCACA;kCACAA;gCACA;gCACA;gCACA;kCACAA;gCACA;gCACAsC;gCACAA;gCACA;gCACA;8BACA;;8BACA;gCACA9F;gCACA;kCACA;kCACAsD;gCACA;8BACA;4BAAA;4BAAA;8BAAA;0BAAA;wBAAA;sBAAA;oBAAA,CACA;oBAAA;sBAAA;oBAAA;oBAAA;kBAAA;kBACAQ;oBACA;sBACAuB;oBACA;oBACA;oBACA;oBACAnF;sBACA;oBACA;oBACA;sBACA;oBACA;kBACA;kBACA6F;oBACA/F;oBACA;oBACA;oBACA;oBACA6B;sBACAZ;sBACA2C;oBACA;oBACA;oBACA;sBACAsB;oBACA;kBACA;gBACA;gBACAtF;cAAA;cAAA;gBAAA;YAAA;UAAA;QAAA;MAAA;IACA;IACAoG;MACA;MACA;QACAhB;QACA;QACAA;QACA;MACA;MACA;MACApF;MACA;MACA;IACA;IACA;IACAqG;MAAA;MACA;MACA;QACA;QACA;QACA;QACA;UACA;UACA;QACA;MACA;IACA;IACA;IACAC;MAAA;MACA;MACArE;QACAE;QACAd;QACA6C;UACA;UACA;YACA;YACA;YACA;YACA;UACA;QACA;MACA;IACA;EACA;AACA;AAAA,2B;;;;;;;;;;;;;AC/5BA;AAAA;AAAA;AAAA;AAAy8C,CAAgB,05CAAG,EAAC,C;;;;;;;;;;;ACA79C;AACA,OAAO,KAAU,EAAE,kBAKd","file":"pages/aichat/aichat.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/aichat/aichat.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./aichat.vue?vue&type=template&id=67897dc6&\"\nvar renderjs\nimport script from \"./aichat.vue?vue&type=script&lang=js&\"\nexport * from \"./aichat.vue?vue&type=script&lang=js&\"\nimport style0 from \"./aichat.vue?vue&type=style&index=0&lang=scss&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/aichat/aichat.vue\"\nexport default component.exports","export * from \"-!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./aichat.vue?vue&type=template&id=67897dc6&\"","var components\ntry {\n  components = {\n    uniAiMsg: function () {\n      return import(\n        /* webpackChunkName: \"components/uni-ai-msg/uni-ai-msg\" */ \"@/components/uni-ai-msg/uni-ai-msg.vue\"\n      )\n    },\n    uniIcons: function () {\n      return import(\n        /* webpackChunkName: \"uni_modules/uni-icons/components/uni-icons/uni-icons\" */ \"@/uni_modules/uni-icons/components/uni-icons/uni-icons.vue\"\n      )\n    },\n  }\n} catch (e) {\n  if (\n    e.message.indexOf(\"Cannot find module\") !== -1 &&\n    e.message.indexOf(\".vue\") !== -1\n  ) {\n    console.error(e.message)\n    console.error(\"1. 排查组件名称拼写是否正确\")\n    console.error(\n      \"2. 排查组件是否符合 easycom 规范，文档：https://uniapp.dcloud.net.cn/collocation/pages?id=easycom\"\n    )\n    console.error(\n      \"3. 若组件不符合 easycom 规范，需手动引入，并在 components 中注册该组件\"\n    )\n  } else {\n    throw e\n  }\n}\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  var g0 = _vm.msgList.length\n  var g2 = _vm.msgList.length\n  var l0 = _vm.__map(_vm.msgList, function (msg, index) {\n    var $orig = _vm.__get_orig(msg)\n    var g1 =\n      index == _vm.msgList.length - 1 &&\n      _vm.msgList.length % 2 === 0 &&\n      _vm.sseIndex\n    return {\n      $orig: $orig,\n      g1: g1,\n    }\n  })\n  var g3 = _vm.msgList.length\n  var g4 =\n    g3 % 2 !== 0 && !(_vm.requestState == -100) ? _vm.msgList.length : null\n  var g5 = _vm.msgList.length && _vm.msgList.length % 2 !== 0\n  _vm.$mp.data = Object.assign(\n    {},\n    {\n      $root: {\n        g0: g0,\n        g2: g2,\n        l0: l0,\n        g3: g3,\n        g4: g4,\n        g5: g5,\n      },\n    }\n  )\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./aichat.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./aichat.vue?vue&type=script&lang=js&\"","<template>\r\n\t<view class=\"container\">\r\n\t\t<cu-custom bgColor=\"bg-gradual-blue\" style=\"width: 100%;\" :isBack=\"true\">\r\n\t\t\t<block slot=\"content\" style=\"position: relative;left:30%;\">AI问答</block>\r\n\t\t</cu-custom>\r\n\t\t<!-- #ifdef H5 -->\r\n\t\t<!-- <view v-if=\"isWidescreen\" class=\"header\">AI Chat</view> -->\r\n\t\t<!-- #endif -->\r\n\t\t<text class=\"noData\" v-if=\"msgList.length === 0\">没有对话记录</text>\r\n\r\n\t\t<scroll-view :scroll-top=\"scrollTop\" :scroll-into-view=\"scrollIntoView\" scroll-y=\"true\" class=\"msg-list\"\r\n\t\t\t:enable-flex=\"true\">\r\n\t\t\t<uni-ai-msg ref=\"msg\" v-for=\"(msg,index) in msgList\" :key=\"index\" :msg=\"msg\" @changeAnswer=\"changeAnswer\"\r\n\t\t\t\t:show-cursor=\"index == msgList.length - 1 && msgList.length%2 === 0 && sseIndex\"\r\n\t\t\t\t:isLastMsg=\"index == msgList.length - 1\" :headimg='headimg' @removeMsg=\"removeMsg(index)\"></uni-ai-msg>\r\n\t\t\t<template v-if=\"msgList.length%2 !== 0\">\r\n\t\t\t\t<view v-if=\"requestState == -100\" class=\"retries-box\">\r\n\t\t\t\t\t<text>消息发送失败</text>\r\n\t\t\t\t\t<uni-icons @click=\"send\" color=\"#d22\" type=\"refresh-filled\" class=\"retries-icon\"></uni-icons>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"tip-ai-ing\" v-else-if=\"msgList.length\">\r\n\t\t\t\t\t<text>智能搜索中...</text>\r\n\t\t\t\t\t<!-- <view v-if=\"NODE_ENV == 'development' && !enableStream\">\r\n\t\t\t\t\t\t如需提速，请开通<uni-link class=\"uni-link\" href=\"https://uniapp.dcloud.net.cn/uniCloud/uni-ai-chat.html\"\r\n\t\t\t\t\t\t\ttext=\"[流式响应]\"></uni-link>\r\n\t\t\t\t\t</view> -->\r\n\t\t\t\t</view>\r\n\t\t\t</template>\r\n\t\t\t<!-- <view v-if=\"adpid\" class=\"open-ad-btn-box\">\r\n\t\t\t\t<text style=\"color: red;\">\r\n\t\t\t\t\t默认不启用广告组件(被注释)，如需使用，请\"去掉注释\"(“重新运行”后生效)\r\n\t\t\t\t\t位置：/pages/chat/chat.vue 第30行，或全局搜索 uni-ad-rewarded-video\r\n\t\t\t\t</text>\r\n\t\t\t</view>\r\n\t\t\t<view @click=\"closeSseChannel\" class=\"stop-responding\" v-if=\"sseIndex\"> ▣ 停止响应</view>\r\n\t\t\t<view id=\"last-msg-item\" style=\"height: 1px;\"></view> -->\r\n\t\t</scroll-view>\r\n\r\n\t\t<view class=\"foot-box\" :style=\"{'padding-bottom':footBoxPaddingBottom}\">\r\n\t\t\t<!-- #ifdef H5 -->\r\n\t\t\t<view class=\"pc-menu\" v-if=\"isWidescreen\">\r\n\t\t\t\t<view class=\"pc-trash pc-menu-item\" @click=\"clearAllMsg\" title=\"删除\">\r\n\t\t\t\t\t<image src=\"@/static/remove.png\" mode=\"heightFix\"></image>\r\n\t\t\t\t</view>\r\n\t\t\t\t<!-- <view class=\"settings pc-menu-item\" @click=\"setLLMmodel\" title=\"设置\">\r\n\t\t\t\t\t<uni-icons color=\"#555\" size=\"20px\" type=\"settings\"></uni-icons>\r\n\t\t\t\t</view> -->\r\n\t\t\t</view>\r\n\t\t\t<!-- #endif -->\r\n\t\t\t<view class=\"foot-box-content\">\r\n\t\t\t\t<view v-if=\"!isWidescreen\" class=\"menu\">\r\n\t\t\t\t\t<uni-icons class=\"menu-item\" @click=\"clearAllMsg\" type=\"trash\" size=\"24\" color=\"#888\"></uni-icons>\r\n\t\t\t\t\t<!-- <uni-icons class=\"menu-item\" @click=\"setLLMmodel\" color=\"#555\" size=\"20px\"\r\n\t\t\t\t\t\ttype=\"settings\"></uni-icons> -->\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"textarea-box\">\r\n\t\t\t\t\t<textarea v-model=\"content\" :cursor-spacing=\"15\" class=\"textarea\" :auto-height=\"!isWidescreen\"\r\n\t\t\t\t\t\tplaceholder=\"请输入需要搜索的内容\" :maxlength=\"-1\" :adjust-position=\"false\"\r\n\t\t\t\t\t\t:disable-default-padding=\"false\" placeholder-class=\"input-placeholder\"></textarea>\r\n\t\t\t\t</view>\r\n\t\t\t\t<view class=\"send-btn-box\" :title=\"(msgList.length && msgList.length%2 !== 0) ? 'ai正在回复中不能发送':''\">\r\n\t\t\t\t\t<!-- #ifdef H5 -->\r\n\t\t\t\t\t<!-- <text v-if=\"isWidescreen\" class=\"send-btn-tip\">↵ 发送 / shift + ↵ 换行</text> -->\r\n\t\t\t\t\t<!-- #endif -->\r\n\t\t\t\t\t<button @click=\"beforeSend\" :disabled=\"inputBoxDisabled || !content\" class=\"send\"\r\n\t\t\t\t\t\ttype=\"primary\">发送</button>\r\n\t\t\t\t</view>\r\n\t\t\t</view>\r\n\t\t</view>\r\n\t<!-- \t<llm-config ref=\"llm-config\"></llm-config> -->\r\n\t</view>\r\n</template>\r\n\r\n<script>\r\n\t// 引入配置文件\r\n\timport config from '@/config.js';\r\n\r\n\t// 导入uniCloud云对象task模块\r\n\timport uniCoTask from '@/common/unicloud-co-task.js';\r\n\t// 导入 将多个字消息文本，分割成单个字 分批插入到最末尾的消息中 的类\r\n\timport SliceMsgToLastMsg from './SliceMsgToLastMsg.js';\r\n\t// 收集所有执行云对象的任务列表\r\n\tlet uniCoTaskList = []\r\n\t// 定义终止并清空 云对象的任务列表中所有 任务的方法\r\n\tuniCoTaskList.clear = function() {\r\n\t\t// 执行数组内的所有任务\r\n\t\tuniCoTaskList.forEach(task => task.abort())\r\n\t\t// 清空数组\r\n\t\tuniCoTaskList.slice(0, uniCoTaskList.length)\r\n\t}\r\n\r\n\t// 获取广告id\r\n\tconst {\r\n\t\tadpid\r\n\t} = config\r\n\t// 初始化sse通道\r\n\tlet sseChannel = false;\r\n\r\n\t// 键盘的shift键是否被按下\r\n\tlet shiftKeyPressed = false\r\n\r\n\texport default {\r\n\t\tonLoad(options) {\r\n\t\t\t\r\n\t\t\tthis.tiwen = options.tiwen || ''\r\n\t\t\tthis.userinfoObj = uni.getStorageSync('userinfo')\r\n\t\t\tthis.titleext = options.titleext\r\n\t\t\tthis.headimg = '../../static/chatlogo.png'\r\n\t\t\tthis.keywordstr = options.keywordstr\r\n\t\t\tthis.typeid = options.typeid\r\n\t\t\tthis.storagedata = 'uni-ai-msg-' + this.typeid + '-' + this.userinfoObj.id\r\n\t\t\tthis.tiwen = options.tiwen || ''\r\n\t\t\t// if(this.tiwen != ''){\r\n\t\t\t// \tsetTimeout(() => {\r\n\t\t\t// \t\t//自动提问\r\n\t\t\t// \t\tthis.content = `你对${this.tiwen}有什么看法？`\r\n\t\t\t// \t\tthis.beforeSend();\r\n\t\t\t// \t}, 500)\r\n\t\t\t// }\r\n\t\t\tconsole.log(this.storagedata)\r\n\t\t\tlet storagedata = this.storagedata\r\n\t\t\t this.msgList = uni.getStorage({key:storagedata})\r\n\t\t\tconsole.log('seeect',this.msgList)\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tthis.scrollTop = this.scrollTop + 1;\r\n\t\t\t}, 100)\r\n\t\t},\r\n\t\tonShow() {\r\n\r\n\t\t},\r\n\t\tdata() {\r\n\t\t\treturn {\r\n\t\t\t\ttiwen:'',\r\n\t\t\t\tscrollTop: 99999,\r\n\t\t\t\tuserinfoObj: {},\r\n\t\t\t\tstoragedata: '',\r\n\t\t\t\ttypeid: '',\r\n\t\t\t\ttitleext: '',\r\n\t\t\t\theadimg: '',\r\n\t\t\t\tkeywordstr: '',\r\n\t\t\t\t// 使聊天窗口滚动到指定元素id的值\r\n\t\t\t\tscrollIntoView: \"\",\r\n\t\t\t\t// 消息列表数据\r\n\t\t\t\tmsgList: [],\r\n\t\t\t\t// 通讯请求状态\r\n\t\t\t\trequestState: 0, //0发送中 100发送成功 -100发送失败\r\n\t\t\t\t// 本地对话是否因积分不足而终止\r\n\t\t\t\tinsufficientScore: false,\r\n\t\t\t\t// 输入框的消息内容\r\n\t\t\t\tcontent: \"\",\r\n\t\t\t\t// 记录流式响应次数\r\n\t\t\t\tsseIndex: 0,\r\n\t\t\t\t// 是否启用流式响应模式\r\n\t\t\t\tenableStream: false,\r\n\t\t\t\t// 当前屏幕是否为宽屏\r\n\t\t\t\tisWidescreen: false,\r\n\t\t\t\t// 广告位id\r\n\t\t\t\tadpid,\r\n\t\t\t\tllmModel: false,\r\n\t\t\t\tkeyboardHeight: 0\r\n\t\t\t}\r\n\t\t},\r\n\t\tcomputed: {\r\n\t\t\t// 输入框是否禁用\r\n\t\t\tinputBoxDisabled() {\r\n\t\t\t\t// 如果正在等待流式响应，则禁用输入框\r\n\t\t\t\tif (this.sseIndex !== 0) {\r\n\t\t\t\t\treturn true\r\n\t\t\t\t}\r\n\t\t\t\t// 如果消息列表长度为奇数，则禁用输入框\r\n\t\t\t\treturn !!(this.msgList.length && this.msgList.length % 2 !== 0)\r\n\t\t\t},\r\n\t\t\t// 获取当前环境\r\n\t\t\tNODE_ENV() {\r\n\t\t\t\treturn process.env.NODE_ENV\r\n\t\t\t},\r\n\t\t\tfootBoxPaddingBottom() {\r\n\t\t\t\treturn (this.keyboardHeight || 10) + 'px'\r\n\t\t\t}\r\n\t\t},\r\n\t\t// 监听msgList变化，将其存储到本地缓存中\r\n\t\twatch: {\r\n\t\t\tmsgList: {\r\n\t\t\t\thandler(msgList) {\r\n\t\t\t\t\tlet storagedata = this.storagedata\r\n\t\t\t\t\t// 将msgList存储到本地缓存中\r\n\t\t\t\t\tuni.setStorage({\r\n\t\t\t\t\t\t\"key\": storagedata,\r\n\t\t\t\t\t\t\"data\": msgList\r\n\t\t\t\t\t})\r\n\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\tthis.scrollTop = this.scrollTop + 1;\r\n\t\t\t\t\t}, 100)\r\n\t\t\t\t},\r\n\t\t\t\t// 深度监听msgList变化\r\n\t\t\t\tdeep: true\r\n\t\t\t},\r\n\t\t\tinsufficientScore(insufficientScore) {\r\n\t\t\t\tuni.setStorage({\r\n\t\t\t\t\t\"key\": \"uni-ai-chat-insufficientScore\",\r\n\t\t\t\t\t\"data\": insufficientScore\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\tllmModel(llmModel) {\r\n\t\t\t\tlet title = 'AI chat'\r\n\t\t\t\tif (llmModel) {\r\n\t\t\t\t\ttitle += ` (${llmModel})`\r\n\t\t\t\t}\r\n\t\t\t\t// uni.setNavigationBarTitle({title})\r\n\t\t\t\t// #ifdef H5\r\n\t\t\t\tif (this.isWidescreen) {\r\n\t\t\t\t\tdocument.querySelector('.header').innerText = title\r\n\t\t\t\t}\r\n\t\t\t\t// #endif\r\n\t\t\t\tuni.setStorage({\r\n\t\t\t\t\tkey: 'uni-ai-chat-llmModel',\r\n\t\t\t\t\tdata: llmModel\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t},\r\n\t\tbeforeMount() {\r\n\t\t\t// #ifdef H5\r\n\t\t\t// 监听屏幕宽度变化，判断是否为宽屏 并设置isWidescreen的值\r\n\t\t\tuni.createMediaQueryObserver(this).observe({\r\n\t\t\t\tminWidth: 650,\r\n\t\t\t}, matches => {\r\n\t\t\t\tthis.isWidescreen = matches;\r\n\t\t\t})\r\n\t\t\t// #endif\r\n\t\t},\r\n\t\tasync mounted() {\r\n\t\t\t// 如果存在广告位id且用户token未过期\r\n\t\t\tif (this.adpid && uniCloud.getCurrentUserInfo().tokenExpired > Date.now()) {\r\n\t\t\t\t// 查询当前用户的积分\r\n\t\t\t\t// 获取数据库对象\r\n\t\t\t\tlet db = uniCloud.databaseForJQL();\r\n\t\t\t\t// 获取uni-id-users集合\r\n\t\t\t\tlet res = await db.collection(\"uni-id-users\")\r\n\t\t\t\t\t// 查询条件\r\n\t\t\t\t\t.where({\r\n\t\t\t\t\t\t// 当前用户id\r\n\t\t\t\t\t\t\"_id\": uniCloud.getCurrentUserInfo().uid\r\n\t\t\t\t\t})\r\n\t\t\t\t\t// 返回score字段\r\n\t\t\t\t\t.field('score')\r\n\t\t\t\t\t// 执行查询\r\n\t\t\t\t\t.get()\r\n\t\t\t\t// 输出当前用户积分\r\n\t\t\t\tconsole.log('当前用户有多少积分:', res.data[0] && res.data[0].score);\r\n\t\t\t}\r\n\r\n\t\t\t// for (let i = 0; i < 15; i++) {\r\n\t\t\t// \tthis.msgList.push({\r\n\t\t\t// \t\tisAi: i % 2 == true,\r\n\t\t\t// \t\tcontent: \"1-\" + i\r\n\t\t\t// \t})\r\n\t\t\t// }\r\n\r\n\t\t\t// 获得历史对话记录\r\n\t\t\tlet storagedata = this.storagedata\r\n\t\t\tthis.msgList = uni.getStorageSync(storagedata) || [];\r\n\r\n\t\t\t// 获得之前设置的llmModel\r\n\t\t\tthis.llmModel = uni.getStorageSync('uni-ai-chat-llmModel')\r\n\r\n\t\t\t// 获得之前设置的uni-ai-chat-insufficientScore\r\n\t\t\tthis.insufficientScore = uni.getStorageSync('uni-ai-chat-insufficientScore') || false\r\n\r\n\t\t\t// 如果上一次对话中 最后一条消息ai未回复。则一启动就自动重发。\r\n\t\t\tlet length = this.msgList.length\r\n\t\t\tif (length) {\r\n\t\t\t\tlet lastMsg = this.msgList[length - 1]\r\n\t\t\t\tif (!lastMsg.isAi) {\r\n\t\t\t\t\tthis.send()\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// this.msgList.pop()\r\n\t\t\t// console.log('this.msgList', this.msgList);\r\n\r\n\t\t\t// 在dom渲染完毕后 使聊天窗口滚动到最后一条消息\r\n\t\t\tthis.$nextTick(() => {\r\n\t\t\t\tthis.showLastMsg()\r\n\t\t\t})\r\n\r\n\t\t\t// #ifdef H5\r\n\t\t\t//获得消息输入框对象\r\n\t\t\tlet adjunctKeydown = false\r\n\t\t\tconst textareaDom = document.querySelector('.textarea-box textarea');\r\n\t\t\tif (textareaDom) {\r\n\t\t\t\t//键盘按下时\r\n\t\t\t\ttextareaDom.onkeydown = e => {\r\n\t\t\t\t\t// console.log('onkeydown', e.keyCode)\r\n\t\t\t\t\tif ([16, 17, 18, 93].includes(e.keyCode)) {\r\n\t\t\t\t\t\t//按下了shift ctrl alt windows键\r\n\t\t\t\t\t\tadjunctKeydown = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (e.keyCode == 13 && !adjunctKeydown) {\r\n\t\t\t\t\t\te.preventDefault()\r\n\t\t\t\t\t\t// 执行发送\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tthis.beforeSend();\r\n\t\t\t\t\t\t}, 300)\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\t\t\t\ttextareaDom.onkeyup = e => {\r\n\t\t\t\t\t//松开adjunct键\r\n\t\t\t\t\tif ([16, 17, 18, 93].includes(e.keyCode)) {\r\n\t\t\t\t\t\tadjunctKeydown = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t};\r\n\r\n\t\t\t\t// 可视窗口高\r\n\t\t\t\tlet initialInnerHeight = window.innerHeight;\r\n\t\t\t\tif (uni.getSystemInfoSync().platform == \"ios\") {\r\n\t\t\t\t\ttextareaDom.addEventListener('focus', () => {\r\n\t\t\t\t\t\tlet interval = setInterval(function() {\r\n\t\t\t\t\t\t\tif (window.innerHeight !== initialInnerHeight) {\r\n\t\t\t\t\t\t\t\tclearInterval(interval)\r\n\t\t\t\t\t\t\t\t// 触发相应的回调函数\r\n\t\t\t\t\t\t\t\tdocument.querySelector('.container').style.height = window\r\n\t\t\t\t\t\t\t\t\t.innerHeight + 'px'\r\n\t\t\t\t\t\t\t\twindow.scrollTo(0, 0);\r\n\t\t\t\t\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}, 1);\r\n\t\t\t\t\t})\r\n\t\t\t\t\ttextareaDom.addEventListener('blur', () => {\r\n\t\t\t\t\t\tdocument.querySelector('.container').style.height = initialInnerHeight + 'px'\r\n\t\t\t\t\t})\r\n\t\t\t\t} else {\r\n\t\t\t\t\twindow.addEventListener('resize', (e) => {\r\n\t\t\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t\t})\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t// #endif\r\n\r\n\t\t\t// #ifndef H5\r\n\t\t\tuni.onKeyboardHeightChange(e => {\r\n\t\t\t\tthis.keyboardHeight = e.height\r\n\t\t\t\t// 在dom渲染完毕后 使聊天窗口滚动到最后一条消息\r\n\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t})\r\n\t\t\t})\r\n\t\t\t// #endif\r\n\t\t},\r\n\t\tmethods: {\r\n\t\t\tsetLLMmodel() {\r\n\t\t\t\tthis.$refs['llm-config'].open(model => {\r\n\t\t\t\t\tconsole.log('model', model);\r\n\t\t\t\t\tthis.llmModel = model\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t// 此(惰性)函数，检查是否开通uni-push;决定是否启用enableStream\r\n\t\t\tasync checkIsOpenPush() {\r\n\t\t\t\ttry {\r\n\t\t\t\t\t// 获取推送客户端id\r\n\t\t\t\t\tawait uni.getPushClientId()\r\n\t\t\t\t\t// 如果获取成功，则将checkIsOpenPush函数重写为一个空函数\r\n\t\t\t\t\tthis.checkIsOpenPush = () => {}\r\n\t\t\t\t} catch (err) {\r\n\t\t\t\t\t// 如果获取失败，则将enableStream设置为false\r\n\t\t\t\t\tthis.enableStream = false\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t// 更新最后一条消息\r\n\t\t\tupdateLastMsg(param) {\r\n\t\t\t\tlet length = this.msgList.length\r\n\t\t\t\tif (length === 0) {\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t\tlet lastMsg = this.msgList[length - 1]\r\n\r\n\t\t\t\t// 如果param是函数，则将最后一条消息作为参数传入该函数\r\n\t\t\t\tif (typeof param == 'function') {\r\n\t\t\t\t\tlet callback = param;\r\n\t\t\t\t\tcallback(lastMsg)\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// 否则，将参数解构为data和cover两个变量\r\n\t\t\t\t\tconst [data, cover = false] = arguments\r\n\t\t\t\t\tif (cover) {\r\n\t\t\t\t\t\tlastMsg = data\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tlastMsg = Object.assign(lastMsg, data)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tthis.msgList.splice(length - 1, 1, lastMsg)\r\n\t\t\t},\r\n\t\t\t// 广告关闭事件\r\n\t\t\tonAdClose(e) {\r\n\t\t\t\tconsole.log('onAdClose e.detail.isEnded', e.detail.isEnded);\r\n\t\t\t\tif (e.detail.isEnded) {\r\n\t\t\t\t\t//5次轮训查结果\r\n\t\t\t\t\tlet i = 0;\r\n\t\t\t\t\tuni.showLoading({\r\n\t\t\t\t\t\tmask: true\r\n\t\t\t\t\t})\r\n\t\t\t\t\tlet myIntive = setInterval(async e => {\r\n\t\t\t\t\t\ti++;\r\n\t\t\t\t\t\t// 获取云数据库实例\r\n\t\t\t\t\t\tconst db = uniCloud.database();\r\n\t\t\t\t\t\t// 获取uni-id-users集合\r\n\t\t\t\t\t\tlet res = await db.collection(\"uni-id-users\")\r\n\t\t\t\t\t\t\t// 查询条件为_id等于当前用户id\r\n\t\t\t\t\t\t\t.where('\"_id\" == $cloudEnv_uid')\r\n\t\t\t\t\t\t\t// 只返回score字段\r\n\t\t\t\t\t\t\t.field('score')\r\n\t\t\t\t\t\t\t// 执行查询\r\n\t\t\t\t\t\t\t.get()\r\n\t\t\t\t\t\t// 解构出score字段的值，如果没有则默认为undefined\r\n\t\t\t\t\t\tlet {\r\n\t\t\t\t\t\t\tscore\r\n\t\t\t\t\t\t} = res.result.data[0] || {}\r\n\t\t\t\t\t\tconsole.log('score', score);\r\n\t\t\t\t\t\tif (score > 0 || i > 5) {\r\n\t\t\t\t\t\t\t// 清除轮询定时器\r\n\t\t\t\t\t\t\tclearInterval(myIntive)\r\n\t\t\t\t\t\t\t// 隐藏加载提示\r\n\t\t\t\t\t\t\tuni.hideLoading()\r\n\t\t\t\t\t\t\tif (score > 0) {\r\n\t\t\t\t\t\t\t\tthis.insufficientScore = false\r\n\t\t\t\t\t\t\t\t// 移除最后一条消息\r\n\t\t\t\t\t\t\t\tthis.msgList.pop()\r\n\t\t\t\t\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\t\t\t\t\t// 重发消息\r\n\t\t\t\t\t\t\t\t\tthis.send()\r\n\t\t\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\t\t\ttitle: '积分余额:' + score,\r\n\t\t\t\t\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, 2000);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t// 换一个答案\r\n\t\t\tasync changeAnswer() {\r\n\t\t\t\t// 如果问题还在回答中需要先关闭\r\n\t\t\t\tif (this.sseIndex) {\r\n\t\t\t\t\tthis.closeSseChannel()\r\n\t\t\t\t}\r\n\t\t\t\t//删除旧的回答\r\n\t\t\t\tthis.msgList.pop()\r\n\t\t\t\tthis.updateLastMsg({\r\n\t\t\t\t\t// 防止 偶发答案涉及敏感，重复回答时。提问内容 被卡掉无法重新问\r\n\t\t\t\t\tillegal: false\r\n\t\t\t\t})\r\n\t\t\t\t// 多设备登录时其他设备看广告后点击重新回答，insufficientScore应当设置为 false\r\n\t\t\t\tthis.insufficientScore = false\r\n\t\t\t\tthis.send()\r\n\t\t\t},\r\n\t\t\tremoveMsg(index) {\r\n\t\t\t\t// 成对删除，如果点中的是 ai 回答的内容，index -= 1\r\n\t\t\t\tif (this.msgList[index].isAi) {\r\n\t\t\t\t\tindex -= 1\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 如果删除的就是正在问的，且问题还在回答中需要先关闭\r\n\t\t\t\tif (this.sseIndex && index == this.msgList.length - 2) {\r\n\t\t\t\t\tthis.closeSseChannel()\r\n\t\t\t\t}\r\n\r\n\t\t\t\tthis.msgList.splice(index, 2)\r\n\t\t\t},\r\n\t\t\tmatchKeywords(str, keywords) {\r\n\t\t\t\tif (!keywords) {\r\n\t\t\t\t\treturn true; // 如果入参为空，则直接输出true\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst keywordArr = keywords.split('#'); // 使用 # 分割关键词子字符串\r\n\t\t\t\tfor (let i = 0; i < keywordArr.length; i++) {\r\n\t\t\t\t\tconst keyword = keywordArr[i];\r\n\t\t\t\t\tif (str.includes(keyword)) {\r\n\t\t\t\t\t\treturn true; // 如果目标字符串包含任一关键词子字符串，则输出true\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn false; // 目标字符串不包含任何关键词子字符串，输出false\r\n\t\t\t},\r\n\t\t\tasync beforeSend() {\r\n\t\t\t\t//this.keywordstr\r\n\t\t\t\t// let flag = this.matchKeywords(this.content, this.keywordstr)\r\n\t\t\t\t// if (!flag && this.titleext != '图片识别') {\r\n\t\t\t\t// \treturn uni.showToast({\r\n\t\t\t\t// \t\ttitle: `请提问与${this.titleext}相关的问题`,\r\n\t\t\t\t// \t\ticon: 'none'\r\n\t\t\t\t// \t});\r\n\t\t\t\t// }\r\n\r\n\r\n\r\n\t\t\t\tif (this.inputBoxDisabled) {\r\n\t\t\t\t\treturn uni.showToast({\r\n\t\t\t\t\t\ttitle: 'ai正在回复中不能发送',\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t// 如果开启了广告位需要登录\r\n\t\t\t\tif (this.adpid) {\r\n\t\t\t\t\t// 获取本地缓存的token\r\n\t\t\t\t\tlet token = uni.getStorageSync('uni_id_token')\r\n\t\t\t\t\t// 如果token不存在\r\n\t\t\t\t\tif (!token) {\r\n\t\t\t\t\t\t// 弹出提示框\r\n\t\t\t\t\t\treturn uni.showModal({\r\n\t\t\t\t\t\t\t// 提示内容\r\n\t\t\t\t\t\t\tcontent: '启用激励视频，客户端需登录并启用安全网络',\r\n\t\t\t\t\t\t\t// 不显示取消按钮\r\n\t\t\t\t\t\t\tshowCancel: false,\r\n\t\t\t\t\t\t\t// 确认按钮文本\r\n\t\t\t\t\t\t\tconfirmText: \"查看详情\",\r\n\t\t\t\t\t\t\t// 弹框关闭后执行的回调函数\r\n\t\t\t\t\t\t\tcomplete() {\r\n\t\t\t\t\t\t\t\t// 文档链接\r\n\t\t\t\t\t\t\t\tlet url = \"https://uniapp.dcloud.net.cn/uniCloud/uni-ai-chat.html#ad\"\r\n\t\t\t\t\t\t\t\t// #ifndef H5\r\n\t\t\t\t\t\t\t\t// 将文档链接复制到剪贴板\r\n\t\t\t\t\t\t\t\tuni.setClipboardData({\r\n\t\t\t\t\t\t\t\t\t// 复制的内容\r\n\t\t\t\t\t\t\t\t\tdata: url,\r\n\t\t\t\t\t\t\t\t\t// 不显示提示框\r\n\t\t\t\t\t\t\t\t\tshowToast: false,\r\n\t\t\t\t\t\t\t\t\t// 复制成功后的回调函数\r\n\t\t\t\t\t\t\t\t\tsuccess() {\r\n\t\t\t\t\t\t\t\t\t\t// 弹出提示框\r\n\t\t\t\t\t\t\t\t\t\tuni.showToast({\r\n\t\t\t\t\t\t\t\t\t\t\t// 提示内容\r\n\t\t\t\t\t\t\t\t\t\t\ttitle: '已复制文档链接，请到浏览器粘贴浏览',\r\n\t\t\t\t\t\t\t\t\t\t\t// 不显示图标\r\n\t\t\t\t\t\t\t\t\t\t\ticon: 'none',\r\n\t\t\t\t\t\t\t\t\t\t\t// 提示框持续时间\r\n\t\t\t\t\t\t\t\t\t\t\tduration: 5000\r\n\t\t\t\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t// #endif\r\n\r\n\t\t\t\t\t\t\t\t// #ifdef H5\r\n\t\t\t\t\t\t\t\t// 在新窗口打开文档链接\r\n\t\t\t\t\t\t\t\twindow.open(url)\r\n\t\t\t\t\t\t\t\t// #endif\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 如果内容为空\r\n\t\t\t\tif (!this.content) {\r\n\t\t\t\t\t// 弹出提示框\r\n\t\t\t\t\treturn uni.showToast({\r\n\t\t\t\t\t\t// 提示内容\r\n\t\t\t\t\t\ttitle: '内容不能为空',\r\n\t\t\t\t\t\t// 不显示图标\r\n\t\t\t\t\t\ticon: 'none'\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 将用户输入的消息添加到消息列表中\r\n\t\t\t\tthis.msgList.push({\r\n\t\t\t\t\t// 标记为非人工智能机器人，即：为用户发送的消息\r\n\t\t\t\t\tisAi: false,\r\n\t\t\t\t\t// 消息内容\r\n\t\t\t\t\tcontent: this.content,\r\n\t\t\t\t\t// 消息创建时间\r\n\t\t\t\t\tcreate_time: Date.now()\r\n\t\t\t\t})\r\n\t\t\t\t//向后台存入数据\r\n\t\t\t\tlet msgobj = {\r\n\t\t\t\t\tusername: this.userinfoObj.userName,\r\n\t\t\t\t\tuserid: this.userinfoObj.id,\r\n\t\t\t\t\taiid: this.typeid,\r\n\t\t\t\t\tainame: this.titleext,\r\n\t\t\t\t\tcontent: this.content,\r\n\t\t\t\t\tisai: 'N'\r\n\t\t\t\t}\r\n\t\t\t\t//let resdata = await new this.Request(this.Urls.m().saveSysques, msgobj).modepost()\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tthis.scrollTop = this.scrollTop + 1;\r\n\t\t\t\t}, 100)\r\n\t\t\t\t// 展示最后一条消息\r\n\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t// dom加载完成后 清空文本内容\r\n\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\tthis.content = ''\r\n\t\t\t\t})\r\n\t\t\t\tconsole.log('查看消息',this.msgList)\r\n\t\t\t\tthis.send() // 发送消息\r\n\t\t\t},\r\n\t\t\tasync send() {\r\n\t\t\t\t// 请求状态归零\r\n\t\t\t\tthis.requestState = 0\r\n\t\t\t\t// 防止重复发起，关闭之前的\r\n\t\t\t\tuniCoTaskList.clear()\r\n\t\t\t\t// 清除旧的afterChatCompletion（如果存在）\r\n\t\t\t\tif (this.afterChatCompletion && this.afterChatCompletion.clear) this.afterChatCompletion.clear()\r\n\r\n\t\t\t\tlet messages = []\r\n\t\t\t\t// 复制一份，消息列表数据\r\n\t\t\t\tlet msgs = JSON.parse(JSON.stringify(this.msgList))\r\n\r\n\t\t\t\t// - 获取上下文的代码【start】-\r\n\t\t\t\t// 带总结的消息 index\r\n\t\t\t\tlet findIndex = [...msgs].reverse().findIndex(item => item.summarize)\r\n\t\t\t\t// console.log('findIndex', findIndex)\r\n\t\t\t\tif (findIndex != -1) {\r\n\t\t\t\t\tlet aiSummaryIndex = msgs.length - findIndex - 1\r\n\t\t\t\t\t// console.log('aiSummaryIndex', aiSummaryIndex)\r\n\t\t\t\t\t// 将带总结的消息的 内容 更换成 总结\r\n\t\t\t\t\tmsgs[aiSummaryIndex].content = msgs[aiSummaryIndex].summarize\r\n\t\t\t\t\t// 拿最后一条带直接的消息作为与ai对话的msg body\r\n\t\t\t\t\tmsgs = msgs.splice(aiSummaryIndex)\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// 如果未总结过就直接从末尾拿10条\r\n\t\t\t\t\tmsgs = msgs.splice(-10)\r\n\t\t\t\t}\r\n\t\t\t\t// 过滤涉敏问题\r\n\t\t\t\tmsgs = msgs.filter(msg => !msg.illegal)\r\n\t\t\t\t// - 获取上下文的代码【end】-\r\n\r\n\t\t\t\t// 如果：不希望带上上下文；请注释掉 上方：获取上下文的代码【start】-【end】。并添加，代码： msgs = [msgs.pop()]\r\n\t\t\t\t// 根据数据内容设置角色\r\n\t\t\t\tmessages = msgs.map(item => {\r\n\t\t\t\t\t// 角色默认为用户\r\n\t\t\t\t\tlet role = \"user\"\r\n\t\t\t\t\t// 如果是ai再根据 是否有总结 来设置角色为 system 还是 assistant\r\n\t\t\t\t\tif (item.isAi) {\r\n\t\t\t\t\t\trole = item.summarize ? 'system' : 'assistant'\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tcontent: item.content,\r\n\t\t\t\t\t\trole\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\r\n\t\t\t\t// 在控制台输出 向ai机器人发送的完整消息内容\r\n\t\t\t\tconsole.log('send to ai messages:', messages);\r\n\t\t\t\t// 检查是否开通uni-push;决定是否启用enableStream\r\n\t\t\t\tawait this.checkIsOpenPush()\r\n\t\t\t\t// console.log('this.enableStream',this.enableStream);\r\n\r\n\t\t\t\t// 流式响应和云对象的请求结束回调函数\r\n\t\t\t\tlet sseEnd, requestEnd;\r\n\t\t\t\t// 判断是否开启了流式响应模式\r\n\t\t\t\tif (this.enableStream) {\r\n\t\t\t\t\t// 创建消息通道\r\n\t\t\t\t\tsseChannel = new uniCloud.SSEChannel()\r\n\t\t\t\t\t// console.log('sseChannel',sseChannel);\r\n\r\n\t\t\t\t\t// 将多个字的文本，分割成单个字 分批插入到最末尾的消息中\r\n\t\t\t\t\tthis.sliceMsgToLastMsg = new SliceMsgToLastMsg(this)\r\n\t\t\t\t\t// 监听message事件\r\n\t\t\t\t\tsseChannel.on('message', (message) => {\r\n\t\t\t\t\t\t// console.log('on message', message);\r\n\t\t\t\t\t\t// 将从云端接收到的消息添加到消息列表中\r\n\r\n\t\t\t\t\t\t// 如果之前未添加过就添加，否则就执行更新最后一条消息\r\n\t\t\t\t\t\tif (this.sseIndex === 0) {\r\n\t\t\t\t\t\t\tthis.msgList.push({\r\n\t\t\t\t\t\t\t\tisAi: true,\r\n\t\t\t\t\t\t\t\tcontent: message,\r\n\t\t\t\t\t\t\t\tcreate_time: Date.now()\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tthis.sliceMsgToLastMsg.addMsg(message)\r\n\t\t\t\t\t\t\t// this.updateLastMsg(lastMsg => {\r\n\t\t\t\t\t\t\t// \tlastMsg.content += message\r\n\t\t\t\t\t\t\t// })\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t\t\t// 让流式响应计数值递增\r\n\t\t\t\t\t\tthis.sseIndex++\r\n\t\t\t\t\t})\r\n\r\n\t\t\t\t\t// 监听end事件，如果云端执行end时传了message，会在客户端end事件内收到传递的消息\r\n\t\t\t\t\tsseChannel.on('end', (e) => {\r\n\t\t\t\t\t\tconsole.log('sse 结束', e)\r\n\t\t\t\t\t\t// 更改“按字分割追加到最后一条消息“的时间间隔为0，即：一次性加载完（不再分割加载）\r\n\t\t\t\t\t\tthis.sliceMsgToLastMsg.t = 0\r\n\t\t\t\t\t\tif (e && typeof e == 'object' && e.errCode) {\r\n\t\t\t\t\t\t\tlet setLastAiMsgContent = (content) => {\r\n\t\t\t\t\t\t\t\t// console.log(content);\r\n\t\t\t\t\t\t\t\t// 如果最后一项不是ai的就添加，否则就执行更新最后一条消息\r\n\t\t\t\t\t\t\t\tif (this.sseIndex === 0) {\r\n\t\t\t\t\t\t\t\t\tthis.msgList.push({\r\n\t\t\t\t\t\t\t\t\t\tisAi: true,\r\n\t\t\t\t\t\t\t\t\t\tcontent,\r\n\t\t\t\t\t\t\t\t\t\tcreate_time: Date.now()\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tthis.updateLastMsg(lastMsg => {\r\n\t\t\t\t\t\t\t\t\t\tlastMsg.content += content\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (e.errCode == 60004) {\r\n\t\t\t\t\t\t\t\t//服务商检测到AI输出了敏感内容\r\n\t\t\t\t\t\t\t\tlet length = this.msgList.length\r\n\t\t\t\t\t\t\t\t//如果最后一项不是ai，就创建一项\r\n\t\t\t\t\t\t\t\tif (length % 2) {\r\n\t\t\t\t\t\t\t\t\tthis.msgList.push({\r\n\t\t\t\t\t\t\t\t\t\tisAi: true,\r\n\t\t\t\t\t\t\t\t\t\tcontent: \"内容涉及敏感\",\r\n\t\t\t\t\t\t\t\t\t\tillegal: true,\r\n\t\t\t\t\t\t\t\t\t\tcreate_time: Date.now()\r\n\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\tlength += 1\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t// 更新倒数第2项 用户提的问题\r\n\t\t\t\t\t\t\t\tthis.msgList[length - 2].illegal = true\r\n\t\t\t\t\t\t\t\t// 更新倒数第1项 ai 回答的内容\r\n\t\t\t\t\t\t\t\tthis.msgList[length - 1].illegal = true\r\n\t\t\t\t\t\t\t\tthis.msgList[length - 1].content = \"内容涉及敏感\"\r\n\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tsetLastAiMsgContent(e.errMsg)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tsseEnd()\r\n\t\t\t\t\t})\r\n\t\t\t\t\tawait sseChannel.open(); // 等待通道开启\r\n\r\n\t\t\t\t\t// 等待对话完成（云函数请求完成，sse 执行了 end）之后\r\n\t\t\t\t\t(function fnSelf(that) {\r\n\t\t\t\t\t\tfnSelf.clear = () => {\r\n\t\t\t\t\t\t\t// console.log('do fnSelf.clear');\r\n\t\t\t\t\t\t\tif (fnSelf.clear.sse) {\r\n\t\t\t\t\t\t\t\t// console.log('fnSelf.clear.sse();')\r\n\t\t\t\t\t\t\t\tfnSelf.clear.sse();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tif (fnSelf.clear.request) {\r\n\t\t\t\t\t\t\t\t// console.log('fnSelf.clear.request();')\r\n\t\t\t\t\t\t\t\tfnSelf.clear.request();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tPromise.all([\r\n\t\t\t\t\t\t\tnew Promise((resolve, reject) => {\r\n\t\t\t\t\t\t\t\tsseEnd = resolve;\r\n\t\t\t\t\t\t\t\tfnSelf.clear.sse = reject;\r\n\t\t\t\t\t\t\t}),\r\n\t\t\t\t\t\t\tnew Promise((resolve, reject) => {\r\n\t\t\t\t\t\t\t\trequestEnd = resolve;\r\n\t\t\t\t\t\t\t\tfnSelf.clear.request = reject;\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t]).then((e) => {\r\n\t\t\t\t\t\t\t// console.log('sseEnd && requestEnd');\r\n\t\t\t\t\t\t\t//当两个都结束时\r\n\t\t\t\t\t\t\tsseChannel.close()\r\n\t\t\t\t\t\t\t// 结束流式响应 将流式响应计数值 设置为 0\r\n\t\t\t\t\t\t\tthat.sseIndex = 0\r\n\t\t\t\t\t\t}).catch((err) => {\r\n\t\t\t\t\t\t\t// console.log('afterChatCompletion is close',err);\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t\tthat.afterChatCompletion = fnSelf\r\n\t\t\t\t\t})(this)\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 导入uni-ai-chat模块，并设置customUI为true\r\n\t\t\t\tlet task = uniCoTask({\r\n\t\t\t\t\tcoName: \"uni-ai-chat\",\r\n\t\t\t\t\tfunName: \"send\",\r\n\t\t\t\t\tparam: [{\r\n\t\t\t\t\t\tmessages, // 消息列表\r\n\t\t\t\t\t\tsseChannel, // 消息通道\r\n\t\t\t\t\t\tllmModel: this.llmModel\r\n\t\t\t\t\t}],\r\n\t\t\t\t\tconfig: {\r\n\t\t\t\t\t\tcustomUI: true\r\n\t\t\t\t\t},\r\n\t\t\t\t\tsuccess: async res => {\r\n\t\t\t\t\t\t// 更新 通讯状态为100（发送成功）\r\n\t\t\t\t\t\tthis.requestState = 100\r\n\t\t\t\t\t\t// console.log(\"success\",res);\r\n\t\t\t\t\t\tif (!res.data) return\r\n\r\n\t\t\t\t\t\tlet {\r\n\t\t\t\t\t\t\treply,\r\n\t\t\t\t\t\t\tsummarize,\r\n\t\t\t\t\t\t\tinsufficientScore,\r\n\t\t\t\t\t\t\tillegal\r\n\t\t\t\t\t\t} = res.data\r\n\r\n\t\t\t\t\t\t// 特殊处理 - start\r\n\t\t\t\t\t\tif (this.enableStream == false && !reply) {\r\n\t\t\t\t\t\t\t//服务商检测到AI输出了敏感内容\r\n\t\t\t\t\t\t\tillegal = true\r\n\t\t\t\t\t\t\treply = \"内容涉及敏感\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// 特殊处理 - end\r\n\r\n\t\t\t\t\t\t// 非流式模式 或者流式模式，但列表还没有数据且已经进入异常的情况下\r\n\t\t\t\t\t\tif (this.enableStream == false || this.sseIndex == 0 && (illegal ||\r\n\t\t\t\t\t\t\t\tinsufficientScore)) {\r\n\t\t\t\t\t\t\t// 将从云端接收到的消息添加到消息列表中\r\n\t\t\t\t\t\t\tthis.msgList.push({\r\n\t\t\t\t\t\t\t\t// 消息创建时间\r\n\t\t\t\t\t\t\t\tcreate_time: Date.now(),\r\n\t\t\t\t\t\t\t\t// 标记消息为来自AI机器人\r\n\t\t\t\t\t\t\t\tisAi: true,\r\n\t\t\t\t\t\t\t\t// 消息内容\r\n\t\t\t\t\t\t\t\tcontent: reply,\r\n\t\t\t\t\t\t\t\t// 消息是否涉敏标记\r\n\t\t\t\t\t\t\t\tillegal\r\n\t\t\t\t\t\t\t})\r\n\r\n\t\t\t\t\t\t\t//向后台存入数据\r\n\t\t\t\t\t\t\tlet msgobj = {\r\n\t\t\t\t\t\t\t\tusername: this.userinfoObj.userName,\r\n\t\t\t\t\t\t\t\tuserid: this.userinfoObj.id,\r\n\t\t\t\t\t\t\t\taiid: this.typeid,\r\n\t\t\t\t\t\t\t\tainame: this.titleext,\r\n\t\t\t\t\t\t\t\tcontent: reply,\r\n\t\t\t\t\t\t\t\tisai: 'Y'\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t//let resdata = await new this.Request(this.Urls.m().saveSysques, msgobj).modepost()\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tif (insufficientScore) {\r\n\t\t\t\t\t\t\t// 积分不足\r\n\t\t\t\t\t\t\tthis.insufficientScore = true\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// 如果回调包含总结的内容，就设置总结\r\n\t\t\t\t\t\tif (summarize) {\r\n\t\t\t\t\t\t\tconsole.log(' 拿到总结', summarize);\r\n\t\t\t\t\t\t\t// 总结的内容是上一轮对话的\r\n\t\t\t\t\t\t\t// console.log('setSummarize');\r\n\t\t\t\t\t\t\tlet index = this.msgList.length - 1;\r\n\t\t\t\t\t\t\t// 如果最后一项是ai就往前退2项，否则退1项（流式响应的时候，回答可能晚于总结）\r\n\t\t\t\t\t\t\tif (index % 2) {\r\n\t\t\t\t\t\t\t\tindex -= 2\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tindex -= 1\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t// 假如第一次提问就需要总结\r\n\t\t\t\t\t\t\tif (index < 1) {\r\n\t\t\t\t\t\t\t\tindex = 1\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tlet msg = this.msgList[index]\r\n\t\t\t\t\t\t\tmsg.summarize = summarize\r\n\t\t\t\t\t\t\tthis.msgList.splice(index, 1, msg)\r\n\t\t\t\t\t\t\t// console.log('setSummarize this.msgList',this.msgList,this.msgList.length-1,index);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (illegal) {\r\n\t\t\t\t\t\t\tconsole.error('内容涉及敏感');\r\n\t\t\t\t\t\t\tthis.updateLastMsg({\r\n\t\t\t\t\t\t\t\t// 添加消息涉敏标记\r\n\t\t\t\t\t\t\t\tillegal: true\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tcomplete: e => {\r\n\t\t\t\t\t\tif (this.enableStream) {\r\n\t\t\t\t\t\t\trequestEnd()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\t// console.log('complete:',e);\r\n\t\t\t\t\t\t// 滚动窗口以显示最新的一条消息\r\n\t\t\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\t\t\tthis.scrollTop = this.scrollTop + 1;\r\n\t\t\t\t\t\t}, 100)\r\n\t\t\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\t\t\tthis.showLastMsg()\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfail: e => {\r\n\t\t\t\t\t\tconsole.error(e);\r\n\t\t\t\t\t\t// 更新 通讯状态为-100（发送失败）\r\n\t\t\t\t\t\tthis.requestState = -100\r\n\t\t\t\t\t\t// 弹框提示用户错误原因\r\n\t\t\t\t\t\tuni.showModal({\r\n\t\t\t\t\t\t\tcontent: JSON.stringify(e.message),\r\n\t\t\t\t\t\t\tshowCancel: false\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t\t// 如果启用流式，云函数出错了，sse 也应当被终止\r\n\t\t\t\t\t\tif (this.enableStream) {\r\n\t\t\t\t\t\t\tsseEnd()\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t})\r\n\t\t\t\tuniCoTaskList.push(task)\r\n\t\t\t},\r\n\t\t\tcloseSseChannel() {\r\n\t\t\t\t// 如果存在消息通道，就关闭消息通道\r\n\t\t\t\tif (sseChannel) {\r\n\t\t\t\t\tsseChannel.close()\r\n\t\t\t\t\t// 设置为 false 防止重复调用closeSseChannel时出错\r\n\t\t\t\t\tsseChannel = false\r\n\t\t\t\t\tthis.sliceMsgToLastMsg.end()\r\n\t\t\t\t}\r\n\t\t\t\t// 清空历史网络请求（调用云对象）任务\r\n\t\t\t\tuniCoTaskList.clear()\r\n\t\t\t\t// 将流式响应计数值归零\r\n\t\t\t\tthis.sseIndex = 0\r\n\t\t\t},\r\n\t\t\t// 滚动窗口以显示最新的一条消息\r\n\t\t\tshowLastMsg() {\r\n\t\t\t\t// 等待DOM更新\r\n\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\t// 将scrollIntoView属性设置为\"last-msg-item\"，以便滚动窗口到最后一条消息\r\n\t\t\t\t\tthis.scrollIntoView = \"last-msg-item\"\r\n\t\t\t\t\t// 等待DOM更新，即：滚动完成\r\n\t\t\t\t\tthis.$nextTick(() => {\r\n\t\t\t\t\t\t// 将scrollIntoView属性设置为空，以便下次设置滚动条位置可被监听\r\n\t\t\t\t\t\tthis.scrollIntoView = \"\"\r\n\t\t\t\t\t})\r\n\t\t\t\t})\r\n\t\t\t},\r\n\t\t\t// 清空消息列表\r\n\t\t\tclearAllMsg(e) {\r\n\t\t\t\t// 弹出确认清空聊天记录的提示框\r\n\t\t\t\tuni.showModal({\r\n\t\t\t\t\ttitle: \"确认要清空聊天记录？\",\r\n\t\t\t\t\tcontent: '本操作不可撤销',\r\n\t\t\t\t\tcomplete: (e) => {\r\n\t\t\t\t\t\t// 如果用户确认清空聊天记录\r\n\t\t\t\t\t\tif (e.confirm) {\r\n\t\t\t\t\t\t\t// 关闭ssh请求\r\n\t\t\t\t\t\t\tthis.closeSseChannel()\r\n\t\t\t\t\t\t\t// 将消息列表清空 \r\n\t\t\t\t\t\t\tthis.msgList.splice(0, this.msgList.length);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n</script>\r\n\r\n<style lang=\"scss\">\r\n\t/* #ifdef VUE3 && APP-PLUS */\r\n\t@import \"@/components/uni-ai-msg/uni-ai-msg.scss\";\r\n\t/* #endif */\r\n\r\n\t/* #ifndef APP-NVUE */\r\n\tpage,\r\n\t/* #ifdef H5 */\r\n\t.container *,\r\n\t/* #endif */\r\n\tview,\r\n\ttextarea,\r\n\tbutton {\r\n\t\tdisplay: flex;\r\n\t\tbox-sizing: border-box;\r\n\t}\r\n\r\n\tpage {\r\n\t\theight: 100%;\r\n\t\twidth: 100%;\r\n\t}\r\n\r\n\t/* #endif */\r\n\r\n\t.stop-responding {\r\n\t\tfont-size: 14px;\r\n\t\tborder-radius: 3px;\r\n\t\tmargin-bottom: 15px;\r\n\t\tbackground-color: #f0b00a;\r\n\t\tcolor: #FFF;\r\n\t\twidth: 90px;\r\n\t\theight: 30px;\r\n\t\tline-height: 30px;\r\n\t\tmargin: 0 auto;\r\n\t\tjustify-content: center;\r\n\t\tmargin-bottom: 15px;\r\n\t\t/* #ifdef H5 */\r\n\t\tcursor: pointer;\r\n\t\t/* #endif */\r\n\t}\r\n\r\n\t.stop-responding:hover {\r\n\t\tbox-shadow: 0 0 10px #aaa;\r\n\t}\r\n\r\n\t.container {\r\n\t\theight: 100%;\r\n\t\tbackground-color: #FAFAFA;\r\n\t\tflex-direction: column;\r\n\t\talign-items: center;\r\n\t\tjustify-content: center;\r\n\t\t// border: 1px solid blue;\r\n\t}\r\n\r\n\t.foot-box {\r\n\t\twidth: 750rpx;\r\n\t\tdisplay: flex;\r\n\t\tflex-direction: column;\r\n\t\tpadding: 10px 0px;\r\n\t\tbackground-color: #FFF;\r\n\t}\r\n\r\n\t.foot-box-content {\r\n\t\tjustify-content: space-around;\r\n\t}\r\n\r\n\t.textarea-box {\r\n\t\tpadding: 8px 10px;\r\n\t\tbackground-color: #f9f9f9;\r\n\t\tborder-radius: 5px;\r\n\t}\r\n\r\n\t.textarea-box .textarea {\r\n\t\tmax-height: 120px;\r\n\t\tfont-size: 14px;\r\n\t\t/* #ifndef APP-NVUE */\r\n\t\toverflow: auto;\r\n\t\t/* #endif */\r\n\t\twidth: 450rpx;\r\n\t\tfont-size: 14px;\r\n\t}\r\n\r\n\t/* #ifdef H5 */\r\n\t/*隐藏滚动条*/\r\n\t.textarea-box .textarea::-webkit-scrollbar {\r\n\t\twidth: 0;\r\n\t}\r\n\r\n\t/* #endif */\r\n\r\n\t.input-placeholder {\r\n\t\tcolor: #bbb;\r\n\t\tline-height: 18px;\r\n\t}\r\n\r\n\t.trash,\r\n\t.send {\r\n\t\twidth: 50px;\r\n\t\theight: 30px;\r\n\t\tjustify-content: center;\r\n\t\talign-items: center;\r\n\t\tflex-shrink: 0;\r\n\t}\r\n\r\n\t.trash {\r\n\t\twidth: 30rpx;\r\n\t\tmargin-left: 10rpx;\r\n\t}\r\n\r\n\t.menu {\r\n\t\tjustify-content: center;\r\n\t\talign-items: center;\r\n\t\tflex-shrink: 0;\r\n\t}\r\n\r\n\t.menu-item {\r\n\t\twidth: 30rpx;\r\n\t\tmargin: 0 10rpx;\r\n\t}\r\n\r\n\t.send {\r\n\t\tcolor: #FFF;\r\n\t\tborder-radius: 4px;\r\n\t\tdisplay: flex;\r\n\t\tmargin: 0;\r\n\t\tpadding: 0;\r\n\t\tfont-size: 14px;\r\n\t\tmargin-right: 20rpx;\r\n\t}\r\n\r\n\t/* #ifndef APP-NVUE */\r\n\t.send::after {\r\n\t\tdisplay: none;\r\n\t}\r\n\r\n\t/* #endif */\r\n\r\n\r\n\t.msg-list {\r\n\t\theight: 0; //不可省略，先设置为0 再由flex: 1;撑开才是一个滚动容器\r\n\t\tflex: 1;\r\n\t\twidth: 750rpx;\r\n\t\t// border: 1px solid red;\r\n\t}\r\n\r\n\t.noData {\r\n\t\tmargin-top: 15px;\r\n\t\ttext-align: center;\r\n\t\twidth: 750rpx;\r\n\t\tcolor: #aaa;\r\n\t\tfont-size: 12px;\r\n\t\tjustify-content: center;\r\n\t}\r\n\r\n\t.open-ad-btn-box {\r\n\t\tjustify-content: center;\r\n\t\tmargin: 10px 0;\r\n\t}\r\n\r\n\t.tip-ai-ing {\r\n\t\talign-items: center;\r\n\t\tflex-direction: column;\r\n\t\tfont-size: 14px;\r\n\t\tcolor: #919396;\r\n\t\tpadding: 15px 0;\r\n\t}\r\n\r\n\t.uni-link {\r\n\t\tmargin-left: 5px;\r\n\t\tline-height: 20px;\r\n\t}\r\n\r\n\t/* #ifdef H5 */\r\n\t@media screen and (min-width:650px) {\r\n\t\t.foot-box {\r\n\t\t\tborder-top: solid 1px #dde0e2;\r\n\t\t}\r\n\r\n\t\t// .container,.container * {\r\n\t\t// \tmax-width: 950px;\r\n\t\t// }\r\n\r\n\t\t.container {\r\n\t\t\tbox-shadow: 0 0 5px #e0e1e7;\r\n\t\t\theight: calc(100vh - 44px);\r\n\t\t\tmargin: 22px auto;\r\n\t\t\tborder-radius: 10px;\r\n\t\t\toverflow: hidden;\r\n\t\t\tbackground-color: #FAFAFA;\r\n\t\t}\r\n\r\n\t\tpage {\r\n\t\t\tbackground-color: #efefef;\r\n\t\t}\r\n\r\n\t\t.container .header {\r\n\t\t\theight: 44px;\r\n\t\t\tline-height: 44px;\r\n\t\t\tborder-bottom: 1px solid #F0F0F0;\r\n\t\t\twidth: 100vw;\r\n\t\t\tjustify-content: center;\r\n\t\t\tfont-weight: 500;\r\n\t\t}\r\n\r\n\t\t.content {\r\n\t\t\tbackground-color: #f9f9f9;\r\n\t\t\tposition: relative;\r\n\t\t\tmax-width: 90%;\r\n\t\t}\r\n\r\n\t\t// .copy {\r\n\t\t// \tcolor: #888888;\r\n\t\t// \tposition: absolute;\r\n\t\t// \tright: 8px;\r\n\t\t// \ttop: 8px;\r\n\t\t// \tfont-size: 12px;\r\n\t\t// \tcursor:pointer;\r\n\t\t// }\r\n\t\t// .copy :hover{\r\n\t\t// \tcolor: #4b9e5f;\r\n\t\t// }\r\n\r\n\t\t.foot-box,\r\n\t\t.foot-box-content,\r\n\t\t.msg-list,\r\n\t\t.msg-item,\r\n\t\t// .create_time,\r\n\t\t.noData,\r\n\t\t.textarea-box,\r\n\t\t.textarea,\r\n\t\ttextarea-box {\r\n\t\t\twidth: 100% !important;\r\n\t\t}\r\n\r\n\t\t.textarea-box,\r\n\t\t.textarea,\r\n\t\ttextarea,\r\n\t\ttextarea-box {\r\n\t\t\theight: 120px;\r\n\t\t}\r\n\r\n\t\t.foot-box,\r\n\t\t.textarea-box {\r\n\t\t\tbackground-color: #FFF;\r\n\t\t}\r\n\r\n\t\t.foot-box-content {\r\n\t\t\tflex-direction: column;\r\n\t\t\tjustify-content: center;\r\n\t\t\talign-items: flex-end;\r\n\t\t\tpadding-bottom: 0;\r\n\t\t}\r\n\r\n\t\t.pc-menu {\r\n\t\t\tpadding: 0 10px;\r\n\t\t}\r\n\r\n\t\t.pc-menu-item {\r\n\t\t\theight: 20px;\r\n\t\t\tjustify-content: center;\r\n\t\t\talign-items: center;\r\n\t\t\talign-content: center;\r\n\t\t\tdisplay: flex;\r\n\t\t\tmargin-right: 10px;\r\n\t\t\tcursor: pointer;\r\n\t\t}\r\n\r\n\t\t.pc-trash {\r\n\t\t\topacity: 0.8;\r\n\t\t}\r\n\r\n\t\t.pc-trash image {\r\n\t\t\theight: 15px;\r\n\t\t}\r\n\r\n\r\n\t\t.textarea-box,\r\n\t\t.textarea-box * {\r\n\t\t\t// border: 1px solid #000;\r\n\t\t}\r\n\r\n\t\t.send-btn-box .send-btn-tip {\r\n\t\t\tcolor: #919396;\r\n\t\t\tmargin-right: 8px;\r\n\t\t\tfont-size: 12px;\r\n\t\t\tline-height: 28px;\r\n\t\t}\r\n\t}\r\n\r\n\t/* #endif */\r\n\t.retries-box {\r\n\t\tjustify-content: center;\r\n\t\talign-items: center;\r\n\t\tfont-size: 12px;\r\n\t\tcolor: #d2071b;\r\n\t}\r\n\r\n\t.retries-icon {\r\n\t\tmargin-top: 1px;\r\n\t\tmargin-left: 5px;\r\n\t}\r\n</style>","import mod from \"-!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./aichat.vue?vue&type=style&index=0&lang=scss&\"; export default mod; export * from \"-!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-2!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-3!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/sass-loader/dist/cjs.js??ref--8-oneOf-1-4!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--8-oneOf-1-5!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./aichat.vue?vue&type=style&index=0&lang=scss&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1745717601437\n      var cssReload = require(\"E:/Completd/HBuilderX.4.45.2025010502/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"/\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}